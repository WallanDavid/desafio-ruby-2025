<div class="d-flex justify-content-between align-items-center mb-4">
  <h2>
    <i class="bi bi-journal-text"></i> Processing Logs
  </h2>
  <div class="text-muted">
    <%= pluralize(@processing_logs.total_count, 'log entry') %>
  </div>
</div>

<div class="card">
  <div class="card-body">
    <%= form_with url: processing_logs_path, method: :get, local: true, class: "row g-3 mb-4" do |form| %>
      <div class="col-md-4">
        <%= form.select :status, 
            options_for_select([
              ['All Statuses', ''],
              ['Success', 'success'],
              ['Failure', 'failure']
            ], params[:status]), 
            {}, 
            { class: "form-select" } %>
      </div>
      <div class="col-md-4">
        <%= form.select :parser, 
            options_for_select([
              ['All Parsers', ''],
              ['Supplier A Parser', 'Parsers::SupplierAParser'],
              ['Partner B Parser', 'Parsers::PartnerBParser']
            ], params[:parser]), 
            {}, 
            { class: "form-select" } %>
      </div>
      <div class="col-md-4">
        <%= form.submit "Filter", class: "btn btn-outline-primary" %>
        <%= link_to "Clear", processing_logs_path, class: "btn btn-outline-secondary" %>
      </div>
    <% end %>

    <% if @processing_logs.any? %>
      <div class="table-responsive">
        <table class="table table-hover">
          <thead class="table-light">
            <tr>
              <th>Status</th>
              <th>Parser</th>
              <th>Email</th>
              <th>Extracted Data</th>
              <th>Error</th>
              <th>Created</th>
            </tr>
          </thead>
          <tbody>
            <% @processing_logs.each do |log| %>
              <tr>
                <td>
                  <span class="badge bg-<%= log.success? ? 'success' : 'danger' %>">
                    <%= log.status.humanize %>
                  </span>
                </td>
                <td>
                  <code><%= log.parser.split('::').last %></code>
                </td>
                <td>
                  <div>
                    <strong><%= log.ingested_email.sender %></strong>
                  </div>
                  <small class="text-muted">
                    <%= truncate(log.ingested_email.subject, length: 30) %>
                  </small>
                </td>
                <td>
                  <% if log.success? && log.extracted_data.any? %>
                    <button class="btn btn-sm btn-outline-info" type="button" data-bs-toggle="collapse" data-bs-target="#data-<%= log.id %>">
                      <i class="bi bi-eye"></i> View
                    </button>
                    <div class="collapse mt-2" id="data-<%= log.id %>">
                      <div class="card card-body">
                        <% log.extracted_data.each do |key, value| %>
                          <% if value.present? %>
                            <div><strong><%= key.humanize %>:</strong> <%= value %></div>
                          <% end %>
                        <% end %>
                      </div>
                    </div>
                  <% else %>
                    <span class="text-muted">-</span>
                  <% end %>
                </td>
                <td>
                  <% if log.failure? && log.error_message.present? %>
                    <button class="btn btn-sm btn-outline-danger" type="button" data-bs-toggle="collapse" data-bs-target="#error-<%= log.id %>">
                      <i class="bi bi-exclamation-triangle"></i> Error
                    </button>
                    <div class="collapse mt-2" id="error-<%= log.id %>">
                      <div class="card card-body">
                        <pre class="small text-danger"><%= log.error_message %></pre>
                      </div>
                    </div>
                  <% else %>
                    <span class="text-muted">-</span>
                  <% end %>
                </td>
                <td>
                  <small class="text-muted">
                    <%= log.created_at.strftime("%m/%d/%Y %H:%M") %>
                  </small>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <div class="d-flex justify-content-between align-items-center mt-3">
        <div>
          <%= page_entries_info @processing_logs %>
        </div>
        <div>
          <%= paginate @processing_logs, theme: 'twitter-bootstrap-4' %>
        </div>
      </div>
    <% else %>
      <div class="text-center py-5">
        <i class="bi bi-journal-x display-1 text-muted"></i>
        <h4 class="mt-3 text-muted">No processing logs found</h4>
        <p class="text-muted">
          <% if params[:status].present? || params[:parser].present? %>
            Try adjusting your filter criteria.
          <% else %>
            Upload some .eml files to start generating processing logs.
          <% end %>
        </p>
      </div>
    <% end %>
  </div>
</div>
